<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phluowise - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=verified" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007ACC',
                        tabActive: '#3B74FF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --input-field-second: #40444B66;
            --input-field-second-border: #808080;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --btn-second-color: #F57D7D4D;
            --btn-second-border: #F57D7D;
            --modal-bg: #101010;
            --modal-border: #DADADA;
        }

        body.dark-theme {
            --bg-color: #060606;
            --bg-second: #1D1D1DF2;
            --bg-third: #101010;
            --header-bg: #101010;
            --tab-bg: #101010;
            --input-field-second: #40444B66;
            --input-field-second-border: #808080;
            --btn-color: #007ACC66;
            --btn-border: #3B74FF;
            --btn-second-color: #F57D7D4D;
            --btn-second-border: #F57D7D;
            --modal-bg: #101010;
            --modal-border: #DADADA;
        }

        body.gray-theme {
            --bg-color: #202225;
            --bg-second: #40444B;
            --bg-third: #292B2F;
            --header-bg: #292B2F;
            --tab-bg: #292B2F;
            --input-field-second: #40444B;
            --input-field-second-border: #40444B;
            --btn-color: #007ACC;
            --btn-border: #007ACC;
            --btn-second-color: #F57D7D;
            --btn-second-border: #F57D7D;
            --modal-bg: #40444B;
            --modal-border: #40444B;
        }

        body.light-theme {
            --bg-color: #202225;
            --bg-second: #40444B;
            --bg-third: #292B2F;
            --header-bg: #292B2F;
            --tab-bg: #292B2F;
            --input-field-second: #40444B;
            --input-field-second-border: #40444B;
            --btn-color: #007ACC;
            --btn-border: #007ACC;
            --btn-second-color: #F57D7D;
            --btn-second-border: #F57D7D;
            --modal-bg: #40444B;
            --modal-border: #40444B;
        }

        body {
            background-color: var(--bg-color);
            color: white;
        }

        /* Material Symbols Styles */
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 1,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
        
        .verified-checkmark {
          color: #FFD700;
          font-size: 20px;
          margin-left: 4px;
          vertical-align: middle;
        }

        .header-bar {
            background-color: var(--header-bg);
        }

        .tab-bar {
            background-color: var(--tab-bg);
        }

        .card-bg {
            background-color: var(--bg-second);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }



        .pull-to-refresh-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 116, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 116, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 0 0 24px 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(59, 116, 255, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pull-to-refresh-indicator.show {
            display: flex;
            animation: slideDown 0.3s ease-out;
        }

        .pull-to-refresh-indicator.refreshing {
            background: rgba(59, 116, 255, 0.25);
            border-color: rgba(59, 116, 255, 0.5);
            box-shadow: 0 12px 40px rgba(59, 116, 255, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.15) inset;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .refresh-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .search-container:focus-within {
            border-color: #3B74FF !important;
            box-shadow: 0 0 0 1px #3B74FF !important;
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-truncate-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body class="dark-theme h-screen flex flex-col overflow-hidden">

    <!-- Top Header Bar (height: 110px) -->
    <div class="header-bar w-full h-[110px] flex flex-row items-center justify-between px-5">
        <!-- Greeting Text -->
        <div class="flex-1">
            <h1 id="greetingText" class="text-white text-lg font-medium truncate max-w-[250px]">
                Good Morning, USER
            </h1>
        </div>

        <!-- Menu Button (Hamburger) -->
        <a href="menu.html"
            class="relative rounded-full flex items-center justify-center h-[45px] w-[45px] border-[0.5px] border-[#808080] bg-[#40444B4D] hover:bg-[#40444B] transition-colors">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <line x1="4" y1="6" x2="20" y2="6" />
                <line x1="4" y1="12" x2="20" y2="12" />
                <line x1="4" y1="18" x2="20" y2="18" />
            </svg>
        </a>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto hide-scrollbar pb-[70px]" style="background-color: var(--bg-color);">

        <!-- Search Company (SearchCompany.tsx) - px-4, py-2 -->
        <div class="px-4 py-2">
            <div class="search-container border w-full h-[42px] rounded-[100px] flex flex-row items-center px-8 gap-4 mt-3"
                style="background-color: var(--input-field-second); border-color: var(--input-field-second-border);">
                <input type="text" id="searchInput" placeholder="Search"
                    class="bg-transparent border-none outline-none text-white text-xl font-medium placeholder-white"
                    style="height: 42px; width: 90%;" oninput="handleSearch()">
                <div>
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Filter Companies (FilterCompanies.tsx) - px-4, py-1 -->
        <div class="px-4 py-1 flex flex-row justify-between items-center">
            <!-- Around you button -->
            <button id="aroundBtn" onclick="setViewFilter('around')"
                class="text-center flex items-center justify-center px-4 h-[40px] rounded-[9px] border transition-all"
                style="background-color: var(--btn-color); border-color: var(--btn-border);">
                <span class="text-white text-lg font-medium">Around you</span>
            </button>

            <div class="flex flex-row gap-2 items-center">
                <!-- All button -->
                <button id="allBtn" onclick="setViewFilter('all')"
                    class="text-center flex items-center justify-center px-4 h-[40px] rounded-[9px] border border-transparent bg-transparent transition-all">
                    <span class="text-white px-4">All</span>
                </button>

                <!-- Grid/List Toggle (48x44px, bg #292B2F, border-radius 10px) -->
                <button id="toggleViewBtn" onclick="toggleCardView()"
                    class="flex items-center justify-center rounded-[10px]"
                    style="height: 48px; width: 44px; background-color: #292B2F;">
                    <!-- Icon will be set by JS -->
                    <div id="toggleIconContainer"></div>
                </button>
            </div>
        </div>

        <!-- Companies List/Grid Container -->
        <div id="companiesContainer" class="mt-2">
            <!-- Will be populated by JS based on view mode -->
        </div>

    </div>

    <!-- Bottom Tab Navigation Bar (3 Tabs - height: 64px) -->
    <div
        class="tab-bar fixed bottom-0 left-0 right-0 h-[64px] flex flex-row justify-around items-center px-4 border-t-0">

        <!-- Home Tab (Active) -->
        <a href="home.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3B74FF" stroke-width="1.5">
                <path
                    d="M9.02 2.84004L3.63 7.04004C2.73 7.74004 2 9.23004 2 10.36V17.77C2 20.09 3.89 21.99 6.21 21.99H17.79C20.11 21.99 22 20.09 22 17.78V10.5C22 9.29004 21.19 7.74004 20.2 7.05004L14.02 2.72004C12.62 1.74004 10.37 1.79004 9.02 2.84004Z"
                    stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 17.99V14.99" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="text-sm text-[#3B74FF] font-normal mt-1">Home</span>
        </a>

        <!-- Services Tab -->
        <a href="services.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path
                    fill="#FFFFFF"
                    d="m31.696 15.098-1.75-4.376a1.742 1.742 0 0 0-1.625-1.1H23.75V8.376a.75.75 0 0 0-.75-.75H4a1.75 1.75 0 0 0-1.75 1.75v14A1.75 1.75 0 0 0 4 25.125h2.325a3.75 3.75 0 0 0 7.35 0h6.65a3.75 3.75 0 0 0 7.35 0H30a1.75 1.75 0 0 0 1.75-1.75v-8a.752.752 0 0 0-.054-.277Zm-7.946-3.973h4.573a.25.25 0 0 1 .232.158l1.337 3.342H23.75v-3.5Zm-20-1.75a.25.25 0 0 1 .25-.25h18.25v8.5H3.75v-8.25ZM10 26.625a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm10.325-3h-6.65a3.75 3.75 0 0 0-7.35 0H4a.25.25 0 0 1-.25-.25v-4.25h18.5v1.935a3.763 3.763 0 0 0-1.925 2.565Zm3.675 3a2.25 2.25 0 1 1 0-4.5 2.25 2.25 0 0 1 0 4.5Zm6.25-3.25a.25.25 0 0 1-.25.25h-2.325a3.756 3.756 0 0 0-3.675-3c-.084 0-.168 0-.25.009v-4.509h6.5v7.25Z"
                />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Services</span>
        </a>

        <!-- Schedule History Tab -->
        <a href="schedule-history.html" class="flex flex-col items-center justify-center gap-1 flex-1">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1.5">
                <path d="M8 2V5" />
                <path d="M16 2V5" />
                <path d="M3.5 9.09H20.5" />
                <path
                    d="M18.2 21.4C19.9673 21.4 21.4 19.9673 21.4 18.2C21.4 16.4327 19.9673 15 18.2 15C16.4327 15 15 16.4327 15 18.2C15 19.9673 16.4327 21.4 18.2 21.4Z" />
                <path d="M22 22L21 21" />
                <path
                    d="M21 8.5V13.63C20.27 13.14 19.38 12.85 18.43 12.85C15.86 12.85 13.78 14.95 13.78 17.54C13.78 18.45 14.04 19.29 14.49 20H8C4.5 20 3 18 3 15V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" />
            </svg>
            <span class="text-sm text-white font-normal mt-1">Schedule History</span>
        </a>

    </div>

    <!-- Location Permission Modal -->
    <div id="locationModal" class="fixed inset-0 z-50 flex items-center justify-center p-9"
        style="display: none; backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.5);">
        <div class="rounded-[30px] w-full max-w-[350px] h-[408px] px-10 py-7 flex flex-col items-center justify-center border-[0.2px]"
            style="background-color: var(--modal-bg); border-color: var(--modal-border);">

            <div class="flex-1 w-full items-center flex-col justify-between relative">
                <!-- Image Section -->
                <div class="items-center flex-1 w-full relative flex items-center justify-center">
                    <img src="../public/images/auth/Ellipse.png" class="w-[119px] h-[117px] object-contain">
                    <img src="../public/images/auth/Location.png"
                        class="w-[51px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 object-contain">
                </div>

                <!-- Text Section -->
                <div class="w-full flex-1 flex-col items-center justify-center">
                    <div class="flex flex-col items-center justify-center">
                        <h2 class="text-white text-center"
                            style="font-size: 20.5px; font-weight: 500; text-transform: capitalize;">
                            Location Permission
                        </h2>
                        <p class="text-white text-center mt-2"
                            style="font-size: 16.5px; font-weight: 500; text-transform: capitalize;">
                            Companies want to access<br> your location for delivery.<br> Grant access
                        </p>
                    </div>
                </div>

                <!-- Buttons Section -->
                <div class="w-full flex-1 flex-col items-center justify-end mt-5">
                    <!-- Deny Button -->
                    <div class="w-full flex items-center mt-5">
                        <button onclick="closeLocationModal()"
                            class="h-[37px] w-[177px] rounded-[100px] flex items-center justify-center border mx-auto"
                            style="background-color: var(--btn-second-color); border-color: var(--btn-second-border);">
                            <span class="text-white text-base font-semibold capitalize"
                                style="font-weight: 500;">Deny</span>
                        </button>
                    </div>
                    <!-- Allow Button -->
                    <div class="w-full flex items-center mt-5">
                        <button onclick="allowLocation()"
                            class="h-[37px] w-[177px] rounded-[100px] flex items-center justify-center border mx-auto"
                            style="background-color: var(--btn-color); border-color: var(--btn-border);">
                            <span class="text-white text-base font-semibold capitalize"
                                style="font-weight: 500;">Allow</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div id="pullToRefreshIndicator" class="pull-to-refresh-indicator">
        <div class="refresh-spinner"></div>
        <span id="refreshText">Pull to refresh</span>
    </div>

    <script src="../public/js/appwriteConfig.js"></script>
    <script src="../public/js/theme.js"></script>
    <script>
        let cardSingle = true; // true = list view, false = grid view
        let currentFilter = 'around';
        let searchQuery = '';
        let userLocation = null;
        let isRefreshing = false;
        let locationPermissionGranted = localStorage.getItem('locationPermissionGranted') === 'true';

        // Sample companies data (placeholder)
        const companies = [
            { id: 1, name: 'Voltic Water Company', location: 'Accra, Ghana', time: '23 minutes away', image: '../public/images/main/ScheduleImage1.png', coordinates: { lat: 5.6037, lng: -0.1870 } },
            { id: 2, name: 'Bel-Aqua Ghana', location: 'Tema, Ghana', time: '15 minutes away', image: '../public/images/main/ScheduleImage1.png', coordinates: { lat: 5.6699, lng: -0.0166 } },
            { id: 3, name: 'Special Ice Water', location: 'Kumasi, Ghana', time: '45 minutes away', image: '../public/images/main/ScheduleImage1.png', coordinates: { lat: 6.6885, lng: -1.6244 } },
            { id: 4, name: 'Everpure Water', location: 'Takoradi, Ghana', time: '30 minutes away', image: '../public/images/main/ScheduleImage1.png', coordinates: { lat: 4.8845, lng: -1.7554 } },
            { id: 5, name: 'Aqua Splash', location: 'Cape Coast, Ghana', time: '50 minutes away', image: '../public/images/main/ScheduleImage1.png', coordinates: { lat: 5.1036, lng: -1.2466 } },
            { id: 6, name: 'Pure Life Water', location: 'Ho, Ghana', time: '60 minutes away', image: '../public/images/main/ScheduleImage1.png', coordinates: { lat: 6.6000, lng: 0.4700 } },
        ];

        // Handle search input
        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            searchQuery = searchInput.value.toLowerCase();
            renderCompanies();
        }

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Filter companies based on search query and location
        function getFilteredCompanies() {
            let filtered = companies;

            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(company =>
                    company.name.toLowerCase().includes(searchQuery) ||
                    company.location.toLowerCase().includes(searchQuery)
                );
            }

            // Apply location filter
            if (currentFilter === 'around' && userLocation) {
                filtered = filtered.map(company => ({
                    ...company,
                    distance: calculateDistance(
                        userLocation.lat, userLocation.lng,
                        company.coordinates.lat, company.coordinates.lng
                    )
                })).sort((a, b) => a.distance - b.distance);
            }

            return filtered;
        }

        // Set filter view (Around you / All)
        function setViewFilter(filter) {
            currentFilter = filter;
            const aroundBtn = document.getElementById('aroundBtn');
            const allBtn = document.getElementById('allBtn');

            if (filter === 'around') {
                aroundBtn.style.backgroundColor = 'var(--btn-color)';
                aroundBtn.style.borderColor = 'var(--btn-border)';
                allBtn.style.backgroundColor = 'transparent';
                allBtn.style.borderColor = 'transparent';
            } else {
                allBtn.style.backgroundColor = 'var(--btn-color)';
                allBtn.style.borderColor = 'var(--btn-border)';
                aroundBtn.style.backgroundColor = 'transparent';
                aroundBtn.style.borderColor = 'transparent';
            }
            renderCompanies();
        }

        // Toggle card view (List / Grid)
        function toggleCardView() {
            cardSingle = !cardSingle;
            renderToggleIcon();
            renderCompanies();
        }

        function renderToggleIcon() {
            const container = document.getElementById('toggleIconContainer');
            if (cardSingle) {
                // List view active -> Show Icon for "Grid Switch" which is TableSwipe in RN (Grid of squares)
                container.innerHTML = `
                   <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1" />
                        <rect x="14" y="3" width="7" height="7" rx="1" />
                        <rect x="3" y="14" width="7" height="7" rx="1" />
                        <rect x="14" y="14" width="7" height="7" rx="1" />
                   </svg>
                `;
            } else {
                // Grid view active -> Show List Icon (3 lines)
                container.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3B74FF" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="12" x2="21" y2="12" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="18" x2="21" y2="18" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="4" cy="6" r="1.5" fill="currentColor"/>
                        <circle cx="4" cy="12" r="1.5" fill="currentColor"/>
                        <circle cx="4" cy="18" r="1.5" fill="currentColor"/>
                    </svg>
                `;
            }
        }

        // Render companies based on view mode
        function renderCompanies() {
            const container = document.getElementById('companiesContainer');
            const filteredCompanies = getFilteredCompanies();
            let html = '';

            if (filteredCompanies.length === 0) {
                html = `
                    <div class="flex flex-col items-center justify-center py-20">
                        <div class="text-white text-center">
                            <h3 class="text-xl font-medium mb-2">No companies found</h3>
                            <p class="text-gray-400">Try adjusting your search or location filter</p>
                        </div>
                    </div>
                `;
            } else if (cardSingle) {
                // List View
                html = '<div class="flex flex-col gap-1">';
                filteredCompanies.forEach((company, index) => {
                    const distanceText = company.distance ? `${Math.round(company.distance)} km away` : company.time;
                    html += `
                        <a href="./schedule.html?branch_id=${company.id}" 
                           class="card-bg w-full flex items-center justify-center px-4"
                           style="height: 120px; margin-top: 4px;">
                            <div class="flex flex-row w-full items-center gap-3">
                                <!-- Image -->
                                <div class="rounded-[10px] bg-[#808080] overflow-hidden" style="width: 22%; height: 89px;">
                                    <img src="${company.image}" class="w-full h-full object-cover" alt="${company.name}">
                                </div>
                                <!-- Info -->
                                <div class="flex flex-col gap-2 ml-2 text-left" style="width: 47%;">
                                    <h3 class="text-white text-xl font-medium text-truncate">${company.name}<span class="material-symbols-outlined verified-checkmark">verified</span></h3>
                                    <p class="text-white text-lg font-medium text-truncate">${company.location}</p>
                                    <span class="text-white text-sm font-normal">${distanceText}</span>
                                </div>
                                <!-- View Shop -->
                                <div class="flex flex-col items-center justify-center gap-2" style="width: 20%; height: 60px;">
                                    <img src="../public/images/main/ShopImage.png" class="w-7 h-7" alt="Shop">
                                    <span class="text-white text-base font-medium">View shop</span>
                                </div>
                            </div>
                        </a>
                    `;
                    // Ads banner after 2nd item
                    if (index === 1) html += renderAdsBanner();
                });
                html += '</div>';
            } else {
                // Grid View
                html = `<div class="grid grid-cols-2 gap-[10px] px-[10px] pt-[10px] pb-[100px]">`;
                filteredCompanies.forEach((company, index) => {
                    const distanceText = company.distance ? `${Math.round(company.distance)} km away` : company.time;
                    html += `
                        <a href="./schedule.html?branch_id=${company.id}" 
                           class="flex flex-col items-center rounded-[16px] overflow-hidden"
                           style="height: 175px; margin-bottom: 10px;">
                            <div class="w-full" style="height: 60%;">
                                <img src="${company.image}" class="w-full h-full object-cover" alt="${company.name}">
                            </div>
                            <div class="card-bg relative w-full p-3" style="height: 40%;">
                                <div class="relative rounded-lg overflow-hidden p-[1px]"
                                     style="height: 52px; width: 55px; top: -35px; background-color: #40444B;">
                                    <img src="${company.image}" class="w-full h-full object-cover" alt="Logo">
                                </div>
                                <div class="relative text-left" style="top: -30px;">
                                    <p class="text-white font-medium text-base text-truncate" style="width: 100%;">
                                        ${company.name}<span class="material-symbols-outlined verified-checkmark">verified</span>
                                    </p>
                                </div>
                            </div>
                        </a>
                    `;
                    // Ads banner after 4th item (full width)
                    if (index === 3) html += `<div class="col-span-2">${renderAdsBanner()}</div>`;
                });
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function renderAdsBanner() {
            return `
                <div class="ads-banner w-full flex flex-col items-center justify-center gap-6" style="height: 125px; background: url('../public/images/main/adsBack.png') no-repeat center center; background-size: cover;">
                    <span class="text-white text-base font-semibold">Register for Phluowise Business</span>
                    <button onclick="window.location.href='https://phluowise.com/company'" 
                            class="h-[40px] w-[150px] rounded-[100px] flex items-center justify-center border bg-white border-white">
                        <span class="text-black text-base font-semibold capitalize">Get access</span>
                    </button>
                </div>
            `;
        }

        // Location Modal Logic
        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
        }

        function allowLocation() {
            closeLocationModal();

            if (navigator.geolocation) {
                console.log("üìç Location permission granted - requesting device location...");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("‚úÖ Location access granted successfully");
                        console.log(`üìç Current location: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`);
                        console.log(`üéØ Location accuracy: ¬±${Math.round(position.coords.accuracy)} meters`);

                        // Store permission granted status
                        localStorage.setItem('locationPermissionGranted', 'true');
                        locationPermissionGranted = true;

                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        renderCompanies();
                    },
                    (error) => {
                        console.error("Location access denied", error);
                        // Use default location (Accra) if location access denied
                        userLocation = { lat: 5.6037, lng: -0.1870 };
                        renderCompanies();
                    }
                );
            }
        }

        // Pull-to-refresh functionality
        let pullToRefresh = {
            startY: 0,
            currentY: 0,
            pullDistance: 0,
            isPulling: false,
            threshold: 80
        };

        function initPullToRefresh() {
            const mainContent = document.querySelector('.flex-1.overflow-y-auto');

            mainContent.addEventListener('touchstart', (e) => {
                if (mainContent.scrollTop === 0) {
                    pullToRefresh.startY = e.touches[0].clientY;
                    pullToRefresh.isPulling = true;
                }
            });

            mainContent.addEventListener('touchmove', (e) => {
                if (!pullToRefresh.isPulling) return;

                pullToRefresh.currentY = e.touches[0].clientY;
                pullToRefresh.pullDistance = Math.max(0, pullToRefresh.currentY - pullToRefresh.startY);

                if (pullToRefresh.pullDistance > 0) {
                    e.preventDefault();
                    showPullToRefreshIndicator(pullToRefresh.pullDistance);
                }
            });

            mainContent.addEventListener('touchend', () => {
                if (!pullToRefresh.isPulling) return;

                pullToRefresh.isPulling = false;

                if (pullToRefresh.pullDistance >= pullToRefresh.threshold) {
                    performRefresh();
                } else {
                    hidePullToRefreshIndicator();
                }

                pullToRefresh.pullDistance = 0;
            });
        }

        function showPullToRefreshIndicator(distance) {
            const indicator = document.getElementById('pullToRefreshIndicator');
            const refreshText = document.getElementById('refreshText');

            if (distance >= pullToRefresh.threshold) {
                refreshText.textContent = 'Release to refresh';
                indicator.classList.add('refreshing');
            } else {
                refreshText.textContent = 'Pull to refresh';
                indicator.classList.remove('refreshing');
            }

            indicator.classList.add('show');
        }

        function hidePullToRefreshIndicator() {
            const indicator = document.getElementById('pullToRefreshIndicator');
            indicator.classList.remove('show', 'refreshing');
        }

        function performRefresh() {
            if (isRefreshing) return;

            isRefreshing = true;
            const indicator = document.getElementById('pullToRefreshIndicator');
            const refreshText = document.getElementById('refreshText');

            refreshText.textContent = 'Refreshing...';
            indicator.classList.add('refreshing');

            // Store current state for comparison
            const previousState = {
                filter: currentFilter,
                searchQuery: searchQuery,
                location: userLocation,
                timestamp: Date.now()
            };

            // Enhanced refresh operation with better data management
            refreshCompaniesData(previousState)
                .then(() => {
                    // Hide indicator and reset state
                    hidePullToRefreshIndicator();
                    isRefreshing = false;

                    // Show success feedback
                    refreshText.textContent = 'Updated!';
                    setTimeout(() => {
                        if (!isRefreshing) {
                            refreshText.textContent = 'Pull to refresh';
                        }
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Refresh failed:', error);
                    hidePullToRefreshIndicator();
                    isRefreshing = false;
                    refreshText.textContent = 'Failed to update';
                    setTimeout(() => {
                        if (!isRefreshing) {
                            refreshText.textContent = 'Pull to refresh';
                        }
                    }, 2000);
                });
        }

        async function refreshCompaniesData(previousState) {
            try {
                // Simulate API call with better error handling
                const refreshPromise = new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Simulate random success/failure for demo
                        if (Math.random() > 0.1) { // 90% success rate
                            resolve({ status: 'success', timestamp: Date.now() });
                        } else {
                            reject(new Error('Network error'));
                        }
                    }, 1200);
                });

                const result = await refreshPromise;

                // Update companies data with fresh information
                await updateCompaniesData();

                // Re-render with current filters and search
                renderCompanies();

                // Update distances if location is available and filter is 'around'
                if (userLocation && currentFilter === 'around') {
                    updateDistances();
                    renderCompanies();
                }

                // Log refresh activity
                console.log('‚úÖ Data refreshed successfully at', new Date(result.timestamp).toLocaleTimeString());

                return result;
            } catch (error) {
                console.error('‚ùå Refresh error:', error);
                throw error;
            }
        }

        async function updateCompaniesData() {
            // In a real application, this would fetch from your API
            // For demo, we'll simulate data updates with some randomization
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate slight variations in company data
                    companies.forEach(company => {
                        // Occasionally update delivery times
                        if (Math.random() > 0.7) {
                            const timeVariations = ['12 minutes away', '18 minutes away', '25 minutes away', '35 minutes away'];
                            company.time = timeVariations[Math.floor(Math.random() * timeVariations.length)];
                        }
                    });
                    resolve();
                }, 500);
            });
        }

        function updateDistances() {
            if (!userLocation) return;

            companies.forEach(company => {
                if (company.coordinates) {
                    company.distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        company.coordinates.lat, company.coordinates.lng
                    );
                }
            });

            // Re-sort companies by distance if 'around' filter is active
            if (currentFilter === 'around') {
                companies.sort((a, b) => (a.distance || 0) - (b.distance || 0));
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Theme setup
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.remove('dark-theme', 'gray-theme', 'light-theme');
            document.body.classList.add(savedTheme + '-theme');

            // Set greeting
            const hour = new Date().getHours();
            const userName = localStorage.getItem('userName') || 'USER';
            let greeting = hour < 12 ? 'Good Morning' : (hour < 18 ? 'Good Afternoon' : 'Good Evening');
            document.getElementById('greetingText').textContent = `${greeting}, ${userName.toUpperCase()}`;

            // Initialize pull-to-refresh functionality
            initPullToRefresh();

            // Check location permission after 5 seconds (simulating RN logic)
            setTimeout(() => {
                // Only show modal if permission hasn't been granted or denied before
                const locationPermissionGranted = localStorage.getItem('locationPermissionGranted');
                const locationModal = document.getElementById('locationModal');

                if (locationPermissionGranted === null && locationModal) {
                    console.log("üîî Showing location permission modal for the first time");
                    locationModal.style.display = 'flex';
                } else if (locationPermissionGranted === 'true') {
                    console.log("‚úÖ Location permission previously granted - using stored location");
                    // If permission was granted before, try to get location again
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                console.log("üìç Restored location from previous session");
                                console.log(`üìç Current location: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`);
                                userLocation = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                renderCompanies();
                            },
                            (error) => {
                                console.log("üè† Using default location (previous session location unavailable)");
                                userLocation = { lat: 5.6037, lng: -0.1870 };
                                renderCompanies();
                            }
                        );
                    }
                } else if (locationPermissionGranted === 'false') {
                    console.log("‚ùå Location permission previously denied - using default location");
                    userLocation = { lat: 5.6037, lng: -0.1870 };
                    renderCompanies();
                }
            }, 5000);

            renderToggleIcon();
            renderCompanies();
        });
    </script>
</body>

</html>
